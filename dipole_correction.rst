===========================
Dipole correction in ONETEP
===========================

:Author: Chengcheng Xiao
:Date:   Nov 2025

Dipole correction in ONETEP
===========================

When the system has a net dipole, the electric field generated by it will incur
spurious interaction across periodic images, especially when there's not enough
vacuum space. The goal of applying dipole correction to ONETEP is to eliminate
this effect. An alternative way is to employ coulomb cut-off.

The netdipole moment :math:`\mu` can be easily calculated as,

.. math::

   \boldsymbol{\mu} = \int_\mathrm{cell} \rho(\mathbf{r}) \mathbf{r} d\mathbf{r}

where the total charge density $\rho(\mathbf{r})$ can be decomposed as the
contribution from the electrons and ions

.. math::

   \rho(\mathbf{r}) = -\rho_\mathrm{el}(\mathbf{r}) + \rho_\mathrm{ion}(\mathbf{r})

Correspondingly, the electric field created by this dipole moment can be
expressed as

.. math::

   E = 4\pi(\boldsymbol{\mu}/\Omega)_z

To eliminate this effect, we can insert a dipole layer (by directly manipulating
the external potential) along certain direction. This is done in the spirit of
`JÃ¶rg Neugebauer and Matthias Scheffler
<https://doi.org/10.1103/PhysRevB.46.16067>`__. It is indeed possible to do this
adaptively to counter all dipole correction for molecules and that will be
implemented in the future. For now, the added electric field takes the following
shape


.. math::

   E = 4\pi(\boldsymbol{\mu}/\Omega)_z (z-z_\mathrm{origin})

Furthermore, following the same logic one can add an external electric field by
manipulating

.. math::

   \mu = \mu + \mu_\mathrm{ext}

and in this case, dipole correction could and should be added to make sure the
results are correct.

In ONETEP, dipole correction can be added by 

.. code::

   dipole_correction : T

and the correction direction is set by 

.. code::

   dipole_correction_dir : 3

The location of the dipole layer is set by 

.. code::

   efield_origin : 0.0 0.0 0.0

And a constant external electric field can be added as

.. code::

   constant_efield : 0.0 0.0 1.0


Keywords
========

- ``dipole_correction``: [Basic, bool, default ``F``\ ] Whether to use dipole
  correction or not.

- ``dipole_correction_dir``: [Basic, integer, define ``3``\ ] Direction along
  which the dipole correction is applied. ``1``\ , ``2``\ , ``3``\  correspond
  to x, y, z directions respectively.

- ``efield_origin``: [Basic, float float float, default 0.0 0.0 0.0] Location of
  the dipole layer.

- ``constant_efield``: [Basic, float float float, default 0.0 0.0 0.0] Constant
  external electric field to be added.

